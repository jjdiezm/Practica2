---
title: "Pràctica2: Neteja i Validació de les Dades"
author: "Joaquim Dalmases i Juanjo Díez"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
bibliography: prac2.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      tidy.opts=list(width.cutoff=60))
```

```{r load_libraries, include=FALSE, message=F, warning=F}
library(knitr)
library(stringr)
if(!require(psych)){
    install.packages('psych', repos='http://cran.us.r-project.org')
    library(psych)
}
if(!require(kableExtra)){
    install.packages('kableExtra', repos='http://cran.us.r-project.org')
    library(kableExtra)
}
if(!require(VIM)){
    install.packages('VIM', repos='http://cran.us.r-project.org')
    library(VIM)
}
if(!require(ggplot2)){
    install.packages('ggplot2', repos='http://cran.us.r-project.org')
    library(ggplot2)
}
if(!require(plyr)){
  install.packages('plyr', repos='http://cran.us.r-project.org')
  library(plyr)
}
if(!require(grid)){
  install.packages('grid', repos='http://cran.us.r-project.org')
  library(grid)
}

if(!require(gridExtra)){
  install.packages('gridExtra', repos='http://cran.us.r-project.org')
  library(gridExtra)
}
```

\newpage
# 1 Introducció.

## 1.1 Presentació.
En aquesta pràctica s’elabora un cas pràctic orientat a aprendre a identificar les dades rellevants
per un projecte analític i usar les eines d’integració, neteja, validació i anàlisi de les mateixes. Per
fer aquesta pràctica haureu de treballar en grups de 2 persones. Haureu de lliurar un sol fitxer
amb l’enllaç [Github](https://github.com) on es trobin les solucions incloent els noms dels
components de l’equip. Podeu utilitzar la Wiki de Github per descriure el vostre equip i els
diferents arxius que corresponen a la vostra entrega. Cada membre de l’equip haurà de contribuir
amb el seu usuari Github.

## 1.2 Competències.
En aquesta pràctica es desenvolupen les següents competències del Màster de Data Science:

* Capacitat d'analitzar un problema en el nivell d'abstracció adequat a cada situació i aplicar les habilitats i coneixements adquirits per abordar-lo i resoldre'l.
* Capacitat per aplicar les tècniques específiques de tractament de dades (integració, transformació, neteja i validació) per al seu posterior anàlisi.
Desenvolupar la capacitat de cerca, gestió i ús d'informació i recursos en l'àmbit de la
ciència de dades.

## 1.3 Objectius.
Els objectius concrets d’aquesta pràctica són:

* Aprendre a aplicar els coneixements adquirits i la seva capacitat de resolució de problemes en entorns nous o poc coneguts dintre de contextos més amplis o multidisciplinaris.
* Saber identificar les dades rellevants i els tractaments necessaris (integració, neteja i validació) per dur a terme un projecte analític.
* Aprendre a analitzar les dades adequadament per abordar la informació continguda en les dades.
* Identificar la millor representació dels resultats per tal d’aportar conclusions sobre el problema plantejat en el procés analític.
* Actuar amb els principis ètics i legals relacionats amb la manipulació de dades en funció de l'àmbit d'aplicació.
* Desenvolupar les habilitats d'aprenentatge que els permetin continuar estudiant d'una manera que haurà de ser en gran manera autodirigida o autònoma.

\newpage
# 2 Resolució.

Aquesta pràctica s'ha desenvolupat seguintla bibliografia recomanada: [@apuntsUOC;@cleanData;@dataMining;@introStatistics]

## 2.1 Descripció del dataset.

Per l'elaboració de la pràctica s'ha triat:  

* el repositori de *Kaggle* [**Red Wine Quality**](https://www.kaggle.com/uciml/red-wine-quality-cortez-et-al-2009)
* que correspon amb el repositori de *UCI* [**Wine Quality Data Set**](https://archive.ics.uci.edu/ml/datasets/wine+quality) i
* l'accés a les dades completes es pot trobar a [*aquest enllaç*](https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/).

### 2.1.1 Càrrega de dades
```{r load_data}
# Fixem el directori de treball:
setwd("C:/Users/juanj/OneDrive/Documentos/GitHub/Practica2")

# Llegim els fitxers amb les dades de vins blancs i negres
# Ho ubiquem a dos datasets dsRed i dsWhite.
redFile <-"winequality-red.csv"
whiteFile <-"winequality-white.csv"
dsRed <-read.csv(file.path(getwd(), redFile), sep=";", encoding="UTF-8")
dsWhite <-read.csv(file.path(getwd(), whiteFile), sep=";", encoding="UTF-8")
# Observem que els fitxers originals tenen iguals capçaleres.

# Comprobació de la bona lectura/transferència de dades, mirem les dues primeres fileres 
# de cada dataset i vegem la composició . 
head(dsRed,2)
head(dsWhite,2)

summary(dsRed)
summary(dsWhite)
```

**Perquè és important i quina pregunta/problema pretén respondre?**

El dataset ‘*Red Wine*’ emmagatzema les característiques fisico-químiques de les mostres de vi blanc i negre junt amb el ratio de la qualitat otorgada, en una escala de 0 a 10. Conté 1599 mostres de vi negre de la zona nord de Portugal. 

Cada mostra de vi té assignada un valor de qualitat resultats de proves realitzades en la seva composició (tests de quantitat d’alcohol, nivell d’acidesa, contingut residual de sucres etc…). En total són 12 atributs descrivint característiques entre fisicoquímiques i la classificació de qualitat de la mostra.

Emprearem aquest dataset per respondre a la pregunta de quínes característiques principals defineixen un vi de qualitat?, Varien si es tracta d’un vi negre o blanc?.

Descripció dels atributs o camps del datatset:

Atribut               | Traducció         | Descripció
----------------------|-------------------|-------------------------------------------------------------
**fixed.acidity** | *Acidesa fixe* | És la quantitat d’àcidesa que no s’evapora i per tant resta fixe al vi.
**volatile.acidity** | *Acidesa volàtil* | La quantitat en excès d’àcid acètic en vi, pot afegir sabor amarg o avinagrat, si les quantitats són altes.
**citric.acid** | *Àcid cítric* | Trobat en petites quantitas, l’àcid cítric pot afegir frescor i sabor als vins.
**residual.sugar** | *Sucre residual* | Quantitat de sucre derivada del procés de fermentació (normalment trobem més de 1 gr/litre i si supera els 45grm./litre considerem el vi dolç.
**chlorides** | *Clorurs* | La quantitat de sal del vi.
**free.sulfur.dioxide** | *Diòxid de sofre* | Prevé el creixement microbià i l’oxidació del vi (anti-oxidant). Els vins blancs mantenen millor l’aspecte de vi jove. La normativa de la Comunitat Europea obliga des de l’any 2005 que qualsevol aliment o beguda que contingui més de 10 mg/l de sulfits ha de portar-ho en l’etiqueta com advertència. El motiu és que aquest additiu té capacitat al·lèrgena, és a dir, un petit percentatge de la població pot ser sensible o al·lèrgic als sulfits.
**total.sulfur.dioxide** | *diòxide de sofre total* | Concentracions per sobre de 50 ppm (tant lliure com unit), Es detecta per olfacte i tast. Les quantitats excessives de SO2 poden inhibir la fermentació i causar efectes sensorials indesitjables.
**density** | *Densitat* | Serà propera a la de l’aigua (997 kg/m³) i variaria segons les quantitats de sucre i alcohol, segons la qualitat de la fermentació.
**pH** | *pH* | Descriu com un vi àcid o bàsic és a una escala de 0 (molt àcida) a 14 (molt bàsica); la majoria dels vins tenen entre 3-4 a l’escala de pH.
**sulphates** | *Sulfats* | Un additiu de vi que pot contribuir als nivells de diòxid de sofre (S02), que actuen com a antimicrobians i antioxidants
**alcohol** | *Alcohol* | El percentatge de contingut alcohòlic del vi, és una variable de sortida (basada en dades sensorials)
**quality** | *Qualitat* | (escala 0-10) És la qualitat atorgada la vi.
**color** | *Color* | Determina si el vi és blanc o negre. Afegida per nosaltres a efectes de integrar les dades.

## 2.2 Integració i selecció de les dades d'interés a analitzar.

Disposem de dos fitxers de dades un que conté les característiques del vins blancs i l'altre dels vins negres, per tant ens interesera comprovar que tenen les mateixes capçalers i que els podem integrar en un sol dataset. A més per tal de no perdre informació en la integració afegirem una columna 'color' que identificara la font de les files o mostres emmagatzemant el color del vi amb valors (blanc)

```{r integration}
# Volem analitzar el dataset de Red Wine tenint en compte el color del vi, 
# afegim una columna 'color' i fusionem les dades tant dels vins blancs com 
# dels negres, diferentciant-los per el camp color.

# Afegim el camp 'color' a cada datatset
dsRed["color"]<-"negre"
dsWhite["color"]<-"blanc"

# Tenim capçaleres iguals, si la suma de noms iguals és la suma total de camps.
a<-colnames(dsRed)
b<-colnames(dsWhite)
cat(paste0("El nombre de camps (",ncol(dsRed),") és igual al nombre de camps iguals ",
           sum(a==b),"\n"))
cat("Files - Instàncies de vi negre:",nrow(dsRed),"\nColumnes-Atributs-Variables:",
    ncol(dsRed),"\n")
cat("Files - Instàncies de vi blanc:",nrow(dsWhite),"\nColumnes-Atributs-Variables:",
    ncol(dsWhite),"\n")
# Combinem les mostres dels dos fitxers i factoritzem el camp color per determinar 
# els valors que pren: 'blanc i 'negre'
d<-rbind(dsRed,dsWhite)
d$color<-factor(d$color)

# Dimensions del dataset:
cat("Files - Instàncies:",nrow(d),"\nColumnes-Atributs-Variables:",ncol(d),"\n")

# Revisem l'estructura de camps del datatset:
summary(d)
# write.csv(d,"Dataset_inicial.csv",row.names = FALSE)

```

Com es pot veure ens quedem amb tots els atributs i més tard en la fase d'analisi determinarem si es possible una reducció de camps. Ara per ara podem comptar amb tots els camps disponibles al dataset per esbrinar quíns ens determinaran els vins de millor qualitat.

Si revisem les dades de color podem comprovar que els nombres quadren amb els elements dels datasets originals, pel que s'ens reafirma la correcta integració dels dos.

## 2.3 Neteja de les dades.

### 2.3.1 Zeros i elements buits.

Cerquem elements buits i Na:

```{r na_void}
cat("Valors ´na´: \n")
colSums(is.na(d))
cat("Valors buits: \n")
colSums(d=="")
cat("Zeros: \n")
colSums(d==0)
cat("Vegem si els valors son numérics: \n")
str(d)

```

Podem veure que el dataset no presenta valors nulls (´na´) ni buids ("") i que els zeros s'identifiquen bé: només el camp citric.acid conté valors 0 i que tots els camps son numérics llevat de quality que es sencer i color que és un factor amb dos valors (blanc i negre).

Amb lo que es pot concloure que hem verificat que **no cal tractar buids i Na**.

### 2.3.2 Identificació i tractament de valors extrems.

Representarem boxplots per a les variables numériques i senceres, també destacarem els valors que es troben 3 desviacions típiques per damunt de la mitjana o 3 per davall:

```{r extem_values}
# Prenem els noms de les columnes
columns = colnames(d)
# Excloem el color (és un factor amb 2 valors i no té sentit fer un boxplot)
columns = columns[1:12]
# Montem els boxplots:
for (colu in 1:12){
  boxplot(d[,colu],
          main=columns[colu], 
          col = "orange",
          border = "brown")
}

# Montem un dataframe per a mostrar els valors mínims i màxmims
# la mitjana i el valor de mitjana +- 3*std per veure si hi ha 
# valors molt allunyats

tableOutliers <- data.frame(
  variables = columns,
  stringsAsFactors = FALSE
)

# Valor Mínim
vectorTemp = c()
for (colu in columns) {
   vectorTemp[colu] <- c(min(d[,colu])) 
}
tableOutliers[,"Valor mínim"] <- vectorTemp

# Mitjana - 3sd
vectorTemp = c()
for (colu in columns) {
   vectorTemp[colu] <- c(mean(d[,colu])-3*sd(d[,colu])) 
}
tableOutliers[,"Mitjana - 3 std"] <- vectorTemp

# Mitjana
vectorTemp = c()
for (colu in columns) {
   vectorTemp[colu] <- c(mean(d[,colu]))
}
tableOutliers[,"Mitjana"] <- vectorTemp

# Mitjana + 3sd
vectorTemp = c()
for (colu in columns) {
   vectorTemp[colu] <- c(mean(d[,colu])+3*sd(d[,colu])) 
}
tableOutliers[,"Mitjana + 3 std"] <- vectorTemp

# Valor Máxim
vectorTemp = c()
for (colu in columns) {
   vectorTemp[colu] <- c(max(d[,colu])) 
}
tableOutliers[,"Valor máxim"] <- vectorTemp

# Pintem la taula
knitr::kable(tableOutliers)%>%kable_styling(bootstrap_options = c("striped", "hover"))

```

La taula que em pintat es coherent amb els boxplots, tots ténen outliers mes allunyats per adalt que per abaix, podem veure que no es dona cap cas que el mínim sia inferior a mitjana - 3xstd, però els valors superiors si son en general mes alts que mitjana + 3xstd, les dades de sulfurs i de sucre son molt superiors.

Tot i això com que son mesures químiques **suposarem les dades correctes** ja que no podem afirmar que noes puguin trobar 440 de sulfurs per exemple.

Una altra opció sería limitar substituir els màxims molt allunyats a 3 vegades la std però no ho farem. 

```{r extem_values2}
# df[df==""]<-NA
dfinal <- d
for (colu in columns){
  dfinal[dfinal>mean(dfinal[,colu])+3*sd(dfinal[,colu]),colu]<-mean(dfinal[,colu])+3*sd(dfinal[,colu])
  print(max(d[,colu]))
  print(max(dfinal[,colu]))
}


```

## 2.4 Anàlisi de les dades.

### 2.4.1 Selecció dels grups de dades i planificació dels anàlisis.

### 2.4.2 Comprovació de la normalitat i homogeneïtat de la variància.

### 2.4.3 Aplicació de proves estadístiques per comparar els grups de dades. 

> En funció de les dades i de l’objectiu de l’estudi, aplicar proves de contrast d’hipòtesis, correlacions, regressions, etc. Aplicar almenys tres mètodes d’anàlisi diferents.

## 2.5 Representació dels resultats a partir de taules i gràfiques.

## 2.6. Resolució del problema i conclusions. 

> A partir dels resultats obtinguts, quines són les conclusions? Els resultats permeten respondre al problema?

\newpage
# 3 Recursos
