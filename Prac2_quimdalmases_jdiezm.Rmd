---
title: "Pràctica2: Neteja i Validació de les Dades"
author: "Joaquim Dalmases i Juanjo Díez"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
bibliography: prac2.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      tidy.opts=list(width.cutoff=60))
```

```{r load_libraries, include=FALSE}
library(knitr)
library(stringr)
if(!require(psych)){
    install.packages('psych', repos='http://cran.us.r-project.org')
    library(psych)
}
if(!require(kableExtra)){
    install.packages('kableExtra', repos='http://cran.us.r-project.org')
    library(kableExtra)
}
if(!require(VIM)){
    install.packages('VIM', repos='http://cran.us.r-project.org')
    library(VIM)
}
if(!require(ggplot2)){
    install.packages('ggplot2', repos='http://cran.us.r-project.org')
    library(ggplot2)
}
if(!require(plyr)){
  install.packages('plyr', repos='http://cran.us.r-project.org')
  library(plyr)
}
if(!require(grid)){
  install.packages('grid', repos='http://cran.us.r-project.org')
  library(grid)
}

if(!require(gridExtra)){
  install.packages('gridExtra', repos='http://cran.us.r-project.org')
  library(gridExtra)
}

if(!require(corrplot)){
  install.packages('corrplot', repos='http://cran.us.r-project.org')
  library(corrplot)
}

if(!require(car)){
  install.packages('car', repos='http://cran.us.r-project.org')
  library(car)
}
```

\newpage
# 1 Introducció.

Aquesta Pràctica es troba al repositori: <https://github.com/jjdiezm/Practica2>

Es lliuren el Rmd i el Pdf:

- Prac2_quimdalmases_jdiezm.rmd
- Prac2_quimdalmases_jdiezm.pdf

S'han mantigut diferents versions i fitxers que s'han usat al procés de desenvolupament, però no formen part de l'entregable.

## 1.1 Presentació.
En aquesta pràctica s’elabora un cas pràctic orientat a aprendre a identificar les dades rellevants
per un projecte analític i usar les eines d’integració, neteja, validació i anàlisi de les mateixes. Per
fer aquesta pràctica haureu de treballar en grups de 2 persones. Haureu de lliurar un sol fitxer
amb l’enllaç [Github](https://github.com) on es trobin les solucions incloent els noms dels
components de l’equip. Podeu utilitzar la Wiki de Github per descriure el vostre equip i els
diferents arxius que corresponen a la vostra entrega. Cada membre de l’equip haurà de contribuir
amb el seu usuari Github.

## 1.2 Competències.
En aquesta pràctica es desenvolupen les següents competències del Màster de Data Science:

* Capacitat d'analitzar un problema en el nivell d'abstracció adequat a cada situació i aplicar les habilitats i coneixements adquirits per abordar-lo i resoldre'l.
* Capacitat per aplicar les tècniques específiques de tractament de dades (integració, transformació, neteja i validació) per al seu posterior anàlisi.
Desenvolupar la capacitat de cerca, gestió i ús d'informació i recursos en l'àmbit de la
ciència de dades.

## 1.3 Objectius.
Els objectius concrets d’aquesta pràctica són:

* Aprendre a aplicar els coneixements adquirits i la seva capacitat de resolució de problemes en entorns nous o poc coneguts dintre de contextos més amplis o multidisciplinaris.
* Saber identificar les dades rellevants i els tractaments necessaris (integració, neteja i validació) per dur a terme un projecte analític.
* Aprendre a analitzar les dades adequadament per abordar la informació continguda en les dades.
* Identificar la millor representació dels resultats per tal d’aportar conclusions sobre el problema plantejat en el procés analític.
* Actuar amb els principis ètics i legals relacionats amb la manipulació de dades en funció de l'àmbit d'aplicació.
* Desenvolupar les habilitats d'aprenentatge que els permetin continuar estudiant d'una manera que haurà de ser en gran manera autodirigida o autònoma.

\newpage
# 2 Resolució.

Aquesta pràctica s'ha desenvolupat seguintla bibliografia recomanada: [@apuntsUOC;@cleanData;@dataMining;@introStatistics]

## 2.1 Descripció del dataset.

> Perquè és important i quina pregunta/problema pretén respondre?

Per l'elaboració de la pràctica s'ha triat:  

* el repositori de *Kaggle* [**Red Wine Quality**](https://www.kaggle.com/uciml/red-wine-quality-cortez-et-al-2009)
* que correspon amb el repositori de *UCI* [**Wine Quality Data Set**](https://archive.ics.uci.edu/ml/datasets/wine+quality) i
* l'accés a les dades completes es pot trobar a [*aquest enllaç*](https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/).

### 2.1.1 Càrrega de dades
```{r load_data}
# Fixem el directori de treball:
setwd("C:/Users/juanj/OneDrive/Documentos/GitHub/Practica2")

# Llegim els fitxers amb les dades de vins blancs i negres
# Ho ubiquem a dos datasets dsRed i dsWhite.
redFile <-"winequality-red.csv"
whiteFile <-"winequality-white.csv"
dsRed <-read.csv(file.path(getwd(), redFile), sep=";", encoding="UTF-8")
dsWhite <-read.csv(file.path(getwd(), whiteFile), sep=";", encoding="UTF-8")
# Observem que els fitxers originals tenen iguals capçaleres.

# Comprobació de la bona lectura/transferència de dades, mirem les dues primeres fileres 
# de cada dataset i vegem la composició . 
head(dsRed,2)
head(dsWhite,2)

summary(dsRed)
summary(dsWhite)
```

**Perquè és important i quina pregunta/problema pretén respondre?**

El dataset ‘**Red Wine**’ emmagatzema les característiques fisico-químiques de les mostres de vi blanc i negre junt amb el ratio de la qualitat otorgada, en una escala de 0 a 10. Conté 1599 mostres de vi “Vinho Verde”, negre i 4898 de blanc, de la zona nord de Portugal. 

Cada mostra de vi té assignada un valor de qualitat resultats de proves realitzades en la seva composició (tests de quantitat d’alcohol, nivell d’acidesa, contingut residual de sucres etc…). En total són 12 atributs descrivint característiques entre fisicoquímiques i la classificació de qualitat de la mostra.

Emprearem aquest dataset per respondre a la pregunta de quínes característiques principals defineixen un vi de qualitat?. Cercarem si aquestes canvien segons el color del vi, negre o blanc.

Informació a tenir en compte:
‘Vinho verde’ és un producte únic de la regió de Minho (nord-oest) de Portugal. Es apreciat per les característiques: Alcohol grau mig, i especialment per la seva frescor.

Descripció dels atributs o camps del datatset:

Atribut               | Traducció         | Descripció
----------------------|-------------------|-------------------------------------------------------------
**fixed.acidity** | *Acidesa fixe* | És la quantitat d’àcidesa que no s’evapora i per tant resta fixe al vi.
**volatile.acidity** | *Acidesa volàtil* | La quantitat en excès d’àcid acètic en vi, pot afegir sabor amarg o avinagrat, si les quantitats són altes.
**citric.acid** | *Àcid cítric* | Trobat en petites quantitas, l’àcid cítric pot afegir frescor i sabor als vins.
**residual.sugar** | *Sucre residual* | Quantitat de sucre derivada del procés de fermentació (normalment trobem més de 1 gr/litre i si supera els 45grm./litre considerem el vi dolç.
**chlorides** | *Clorurs* | La quantitat de sal del vi.
**free.sulfur.dioxide** | *Diòxid de sofre* | Prevé el creixement microbià i l’oxidació del vi (anti-oxidant). Els vins blancs mantenen millor l’aspecte de vi jove. La normativa de la Comunitat Europea obliga des de l’any 2005 que qualsevol aliment o beguda que contingui més de 10 mg/l de sulfits ha de portar-ho en l’etiqueta com advertència. El motiu és que aquest additiu té capacitat al·lèrgena, és a dir, un petit percentatge de la població pot ser sensible o al·lèrgic als sulfits.
**total.sulfur.dioxide** | *diòxide de sofre total* | Concentracions per sobre de 50 ppm (tant lliure com unit), Es detecta per olfacte i tast. Les quantitats excessives de SO2 poden inhibir la fermentació i causar efectes sensorials indesitjables.
**density** | *Densitat* | Serà propera a la de l’aigua (997 kg/m³) i variaria segons les quantitats de sucre i alcohol, segons la qualitat de la fermentació.
**pH** | *pH* | Descriu com un vi àcid o bàsic és a una escala de 0 (molt àcida) a 14 (molt bàsica); la majoria dels vins tenen entre 3-4 a l’escala de pH.
**sulphates** | *Sulfats* | Un additiu de vi que pot contribuir als nivells de diòxid de sofre (S02), que actuen com a antimicrobians i antioxidants
**alcohol** | *Alcohol* | El percentatge de contingut alcohòlic del vi, és una variable de sortida (basada en dades sensorials)
**quality** | *Qualitat* | (escala 0-10) És la qualitat atorgada la vi.
**color** | *Color* | Determina si el vi és blanc o negre. Afegida per nosaltres a efectes de integrar les dades.

\newpage
## 2.2 Integració i selecció de les dades d'interés a analitzar.

Disposem de dos fitxers de dades un que conté les característiques del vins blancs i l'altre dels vins negres, per tant ens interesera comprovar que tenen les mateixes capçalers i que els podem integrar en un sol dataset. A més per tal de no perdre informació en la integració afegirem una columna 'color' que identificara la font de les files o mostres emmagatzemant el color del vi amb valors (blanc)

```{r integration}
# Volem analitzar el dataset de Red Wine tenint en compte el color del vi, 
# afegim una columna 'color' i fusionem les dades tant dels vins blancs com 
# dels negres, diferentciant-los per el camp color.

# Afegim el camp 'color' a cada datatset
dsRed["color"]<-"negre"
dsWhite["color"]<-"blanc"

# Tenim capçaleres iguals, si la suma de noms iguals és la suma total de camps.
a<-colnames(dsRed)
b<-colnames(dsWhite)
cat(paste0("El nombre de camps (",ncol(dsRed),") és igual al nombre de camps iguals ",
           sum(a==b),"\n"))
cat("Files - Instàncies de vi negre:",nrow(dsRed),"\nColumnes-Atributs-Variables:",
    ncol(dsRed),"\n")
cat("Files - Instàncies de vi blanc:",nrow(dsWhite),"\nColumnes-Atributs-Variables:",
    ncol(dsWhite),"\n")
# Combinem les mostres dels dos fitxers i factoritzem el camp color per determinar 
# els valors que pren: 'blanc i 'negre'
d<-rbind(dsRed,dsWhite)
d$color<-factor(d$color)

# Dimensions del dataset:
cat("Files - Instàncies:",nrow(d),"\nColumnes-Atributs-Variables:",ncol(d),"\n")

# Revisem l'estructura de camps del datatset:
summary(d)
# write.csv(d,"Dataset_inicial.csv",row.names = FALSE)

```

Com es pot veure ens quedem amb tots els atributs i més tard en la fase d'analisi determinarem si es possible una reducció de camps. Ara per ara podem comptar amb tots els camps disponibles al dataset, per esbrinar quíns ens determinaran la qualitat del vi. Cada característica és candidata per formar part de la composició del vi, i el color ens permerà comparar el seu grau d’importància segons tipus de vi.

A més a més, de la recerca que hem fet sobre el vi ‘Vinho verde’, sabem que tant el camp ‘alcohol’, com el camp ‘citric.acid’ seràn importants, ja que són característiques importants del vi (graduació mitjana en alcohol i sabor fresc).

```{r integratiodsWhite}
cat("Atributs considerats:\n ")
colnames(d)
```

\newpage
## 2.3 Neteja de les dades.

### 2.3.1 Zeros i elements buits.

Cerquem elements buits i Na:

```{r na_void}
cat("Valors ´na´: \n")
colSums(is.na(d))
cat("Valors buits: \n")
colSums(d=="")
cat("Zeros: \n")
colSums(d==0)
cat("Vegem si els valors son numérics: \n")
str(d)

```

Podem veure que el dataset no presenta valors nulls (´na´) ni buids ("") i que els zeros s'identifiquen bé: només el camp citric.acid conté valors 0 i que tots els camps son numérics llevat de quality que es sencer i color que és un factor amb dos valors (blanc i negre).

Amb lo que es pot concloure que hem verificat que **no cal tractar buids i Na**.

La gestió d’aquests cassos, si n'haguès aparegut algún, per aquest dataset podria ser omplir el valor faltant amb el resultat d’usar la imputació per kNN, (‘k-Nearest Neighbors’, es a dir els k-veïns més propers) per omplir els valors perduts (‘NA’).

Per defecte s’utilitza un valor de **k=5** que representa els 5 registres veïns més propers. La mètrica usada podría ser la distància de Gower, usant la resta de variables. El valor usat en la substitució és la mediana d’aquests 5 valors.

Aquesta tècnica és robusta quan existeixen valors extrems (en anglès ‘outliers’). Si sabem que els valors de la mitjana i la mediana són molt propers, podem substituïr els valors faltants per la mitjana o mediana de l’atribut en qüestió.

### 2.3.2 Identificació i tractament de valors extrems.

Per identificar els valors extrems, podem utilitzar l’ordre ‘boxplot.stats’ i el paràmetre de sortida ‘out’ que determina els valors extrems. Es consideren normalment valors extrems o atípics en una mostra, aquells que superen els límits de 3 vegades la desviació típica a banda i banda de la mitjana de la mostra.

Per descriure els valors extrems i la distribució de cada variable hem definit una funció personalitzada on podem observar el histograma, el boxplot (amb valors descriptius com bigotis i mediana) en la mateixa escala i els valors extrems cercats:

```{r extem_values_base}
bxplot_hist<- function(camp,lbcamp){
  par(mfrow=c(2,1))
  boxplot(camp,border="dodgerblue", ylim=c(min(camp,na.rm = TRUE),
                                           max(camp,na.rm = TRUE)), horizontal = TRUE)
  hist(camp,xlim = c(min(camp,na.rm = TRUE),max(camp,na.rm = TRUE)), 
       main="",xlab = lbcamp, ylab="Freqüència", border="blue")
  # Descripció dels valors dels límits d'interpretació del boxplot
  # Vector $Stats indica consecutivament els valors de:
  #    Bigoti inferior, Q1(25%), Mediana, Q3(75%), Bigoti superior.
  # Vector $out  ens proporciona els valors atípics ordenats ascendentment.
  r<-boxplot.stats(camp)
  print("Valors atípics:  ")
  print(r$out)
  cat("\nValors del boxplot:\n1) Bigoti inf.:",r$stats[1],"\n2) Q1(25%)    :", 
      r$stats[2],"\n3) Mediana    :",r$stats[3],"\n4) Q3(75%)    :", 
      r$stats[4],"\n5) Bigoti Sup.:", r$stats[5],"\n")
  }
```

Per cada atribut mirem de trobar els valors extrems i decidim quína estratègia seguir.

#### 2.3.2.1 Valors extrems de l'atribut: fixed.acidity

```{r extem_values_fixed_acidity, out.width='80%'}
# Valors extrems de 'fixed.acidity'
cat("Vi negre \n")
bxplot_hist(dsRed$fixed.acidity,'fixed.acidity')
cat("Vi blanc \n")
bxplot_hist(dsWhite$fixed.acidity,'fixed.acidity')
cat("Vinho verde sense diferenciar color \n")
bxplot_hist(d$fixed.acidity,'fixed.acidity')

```

No tenim constància de que les dades tinguin errors de captura. Els valors poden ser correctes. Els llindars per els valors extrems serien:

```{r fixed_acidity_boundaries}
# Cas Vi negre
# Llindar inferior per els valors atípics de 'fixed.acidity'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$fixed.acidity)-3*sd(dsRed$fixed.acidity))
# Llindar superior per el valors atípics de 'fixed.acidity'.
cat("Vi negre\nLlindar superior:",mean(dsRed$fixed.acidity)+3*sd(dsRed$fixed.acidity))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'fixed.acidity'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$fixed.acidity)-3*sd(dsWhite$fixed.acidity))
# Llindar superior per el valors atípics de 'fixed.acidity'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$fixed.acidity)+3*sd(dsWhite$fixed.acidity))

```

En aquest cas no modifiquem els valors extrems detectats pel camp '*fixed.acidity*'.

#### 2.3.2.2 Valors extrems de l'atribut: volatile.acidity

```{r extem_values_volatile_acidity, out.width='80%'}
# Valors extrems de 'volatile.acidity'
cat("Vi negre")
bxplot_hist(dsRed$volatile.acidity,'volatile.acidity')
cat("Vi blanc")
bxplot_hist(dsWhite$volatile.acidity,'volatile.acidity')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'volatile.acidity'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$volatile.acidity)-3*sd(dsRed$volatile.acidity))
# Llindar superior per el valors atípics de 'volatile.acidity'.
cat("Vi negre\nLlindar superior:",mean(dsRed$volatile.acidity)+3*sd(dsRed$volatile.acidity))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'volatile.acidity'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$volatile.acidity)-3*sd(dsWhite$volatile.acidity))
# Llindar superior per el valors atípics de 'volatile.acidity'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$volatile.acidity)+3*sd(dsWhite$volatile.acidity))

```

La variació d'aquests valors no afecta sensiblement als paràmetres representatius de la seva distribució, 
però si ho necessitem més endavant podriem substituïr el seu valor per el de la mediana `r median(dsRed$volatile.acidity)`, com a valor representatiu de la seva distribució. Mètodes més robustos com  la imputació de dades amb kNN, package R "DMwR" mitjançant la función **knnImputation()**, o el package R "VIM" usant la funció **kNN()** també són una opció.

#### 2.3.2.3 Valors extrems de l'atribut: citric.acid

```{r extem_values_citric_acid, out.width='80%'}
cat("Vi negre")
bxplot_hist(dsRed$citric.acid,'citric.acid')
cat("Vi blanc")
bxplot_hist(dsWhite$citric.acid,'citric.acid')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'citric.acid'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$citric.acid)-3*sd(dsRed$citric.acid))
# Llindar superior per el valors atípics de 'citric.acid'.
cat("Vi negre\nLlindar superior:",mean(dsRed$citric.acid)+3*sd(dsRed$citric.acid))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'citric.acid'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$citric.acid)-3*sd(dsWhite$citric.acid))
# Llindar superior per el valors atípics de 'citric.acid'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$citric.acid)+3*sd(dsWhite$citric.acid))

```

En aquest cas, suposem que tot i que hem trobat valors atípics per el vi negre, amb valor de citric.acid=1.0, 
podrien ser correctes en cassos on es busca donar frescor al vi, (característica d'aquests vins) i tampoc modifiquem 
el valor. Els valors atípics per el vi blanc estàn dintre dels valors correctes del vi negre, i poden ser correctes
per tant els mantenim.

Prenem nota de que el nombre de zeros, és alt (`r length(dsRed[dsRed$citric.acid==0,'citric.acid'])`), respecte el total
 de instàncies `r length(dsRed[,'citric.acid'])` en el cas del vi negre. Podria ser que la característica de 'frescor' fos més freqüent en aquest tipus de vi.

#### 2.3.2.4 Valors extrems de l'atribut: residual.sugar

```{r extem_values_residual_sugar, out.width='80%'}
# Valors extrems de 'residual.sugar'
cat("Vi negre")
bxplot_hist(dsRed$residual.sugar,'residual.sugar')
cat("Vi blanc")
bxplot_hist(dsWhite$residual.sugar,'residual.sugar')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'residual.sugar'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$residual.sugar)-3*sd(dsRed$residual.sugar))
# Llindar superior per el valors atípics de 'residual.sugar'.
cat("Vi negre\nLlindar superior:",mean(dsRed$residual.sugar)+3*sd(dsRed$residual.sugar))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'residual.sugar'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$residual.sugar)-3*sd(dsWhite$residual.sugar))
# Llindar superior per el valors atípics de 'residual.sugar'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$residual.sugar)+3*sd(dsWhite$residual.sugar))

```

En aquest cas hem trobat valors atípics molt extrems.

Si tenim en compte l’escala de dolçor dels vins:

- 0-9 g/l Sucre residual (SR): Sec
- 9-18 g/l: No Sec
- 18-50 g/l: Mig sec-Semi dolç
- 50-120 g/l: mig-dolç
- 120 g/l Dolç-Molt dolç

Deduïm que el ‘Vinho verde’ és un vi que pot ser ‘Sec’, ‘No sec’, ‘Mig sec’ però no ‘Semi dolç’, ‘Mig dolç’ o ‘Dolç-Molt dolç’. Per tant establim un llindar lògic de residual.sugar=18. **Decidim eliminar aquests valors atípics** que hem trobat en el vi blanc, per considerar que són poques instàncies, que representen un 2% del total d’instàncies de vi blanc. Hem observat que la majoria de valors eliminats tenia un valor de qualitat 5,6,7,8 i això implicaria que un valor incorrecte del ‘sucre residual’ no fos una característica que ens ajudes a discriminar la qualitat del vi.

```{r extem_elimination_residual_sugar}
# Eliminem les instàncies amb valors atípics incorrectes.
dsWhite<-dsWhite[dsWhite$residual.sugar<=18,]

```

#### 2.3.2.5 Valors extrems de l'atribut: chlorides

```{r extem_values_chlorides, out.width='80%'}
# Valors extrems de 'chlorides'
cat("Vi negre")
bxplot_hist(dsRed$chlorides,'chlorides')
cat("Vi blanc")
bxplot_hist(dsWhite$chlorides,'chlorides')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'chlorides'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$chlorides)-3*sd(dsRed$chlorides))
# Llindar superior per el valors atípics de 'chlorides'.
cat("Vi negre\nLlindar superior:",mean(dsRed$chlorides)+3*sd(dsRed$chlorides))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'chlorides'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$chlorides)-3*sd(dsWhite$chlorides))
# Llindar superior per el valors atípics de 'chlorides'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$chlorides)+3*sd(dsWhite$chlorides))

```

En el cas dels clorurs també trobem valors extrems molt alts. Per tant actuem de la mateixa manera que amb el sucre residual. **Eliminem aquells valors que no estan en un rang de valors adient per Europa**, ja que sabem que els vins són de Portugal i aquest valor de clorurs és força atípic.

El percentatge d'instàncies eliminades no és gaire gran:

- **`r round(length(dsRed[dsRed$chlorides>0.22,'chlorides'])/length(dsRed[,'chlorides'])*100,0)`%** (vi negre).<br>
- **`r round(length(dsWhite[dsWhite$chlorides>0.11,'chlorides'])/length(dsWhite[,'chlorides'])*100,0)`%** (vi blanc).

```{r extem_elimination_chlorides}
# Eliminem les instàncies amb valors atípics incorrectes.
dsRed<-dsRed[dsRed$chlorides>0 & dsRed$chlorides<=0.22,]
dsWhite<-dsWhite[dsWhite$chlorides>0 & dsWhite$chlorides<=0.11,]

```

#### 2.3.2.6 Valors extrems de l'atribut: free.sulfur.dioxide

```{r extem_values_free_sulfur_dioxide, out.width='80%'}
# Valors extrems de 'free.sulfur.dioxide'
cat("Vi negre")
bxplot_hist(dsRed$free.sulfur.dioxide,'free.sulfur.dioxide')
cat("Vi blanc")
bxplot_hist(dsWhite$free.sulfur.dioxide,'free.sulfur.dioxide')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'free.sulfur.dioxide'.
cat("Vi negre\nLlindar inferior:",
    mean(dsRed$free.sulfur.dioxide)-3*sd(dsRed$free.sulfur.dioxide))
# Llindar superior per el valors atípics de 'free.sulfur.dioxide'.
cat("Vi negre\nLlindar superior:",
    mean(dsRed$free.sulfur.dioxide)+3*sd(dsRed$free.sulfur.dioxide))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'free.sulfur.dioxide'.
cat("Vi blanc\nLlindar inferior:",
    mean(dsWhite$free.sulfur.dioxide)-3*sd(dsWhite$free.sulfur.dioxide))
# Llindar superior per el valors atípics de 'free.sulfur.dioxide'.
cat("Vi negre\nLlindar superior:",
    mean(dsWhite$free.sulfur.dioxide)+3*sd(dsWhite$free.sulfur.dioxide))

```

En el cas del ‘*free.sulfur.dioxide*’, sabem que la normativa admet fins valors de **300 g/l** tot i que a Europa no es solen observar valors superiors a **50 g/l**. 

Observem que els valors atípics tenen valors alts sobretot en el vi blanc, però com no sobrepasen la normativa i poden ser correctes i els valors estan representats en totes les categories de qualitat del vi, **decidim no modificar les dades**. L’ús del ‘*free.sulfur.dioxide*’ en el vi és com a conservant i volem mantenir l’efecte de que és més usat en el vi blanc.

#### 2.3.2.7 Valors extrems de l'atribut: total.sulfur.dioxide

```{r extem_values_total_sulfur_dioxide, out.width='80%'}
# Valors extrems de 'total.sulfur.dioxide'
cat("Vi negre")
bxplot_hist(dsRed$total.sulfur.dioxide,'total.sulfur.dioxide')
cat("Vi blanc")
bxplot_hist(dsWhite$total.sulfur.dioxide,'total.sulfur.dioxide')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'total.sulfur.dioxide'.
cat("Vi negre\nLlindar inferior:",
    mean(dsRed$total.sulfur.dioxide)-3*sd(dsRed$total.sulfur.dioxide))
# Llindar superior per el valors atípics de 'total.sulfur.dioxide'.
cat("Vi negre\nLlindar superior:",
    mean(dsRed$total.sulfur.dioxide)+3*sd(dsRed$total.sulfur.dioxide))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'total.sulfur.dioxide'.
cat("Vi blanc\nLlindar inferior:",
    mean(dsWhite$total.sulfur.dioxide)-3*sd(dsWhite$total.sulfur.dioxide))
# Llindar superior per el valors atípics de 'total.sulfur.dioxide'.
cat("Vi negre\nLlindar superior:",
    mean(dsWhite$total.sulfur.dioxide)+3*sd(dsWhite$total.sulfur.dioxide))

```

En aquest obtenim valors força alts però sabem que aquest camp s’obté de la suma del diòxid de sofre lliure i el fixat, per tant **preveiem que aquest atribut no l’utilitzem en els anàlisis**, per ser combinació lineal de ‘*free.sulfur.dioxide*’.

#### 2.3.2.8 Valors extrems de l'atribut: density

```{r extem_values_density, out.width='80%'}
# Valors extrems de 'density'
cat("Vi negre")
bxplot_hist(dsRed$density,'density')
cat("Vi blanc")
bxplot_hist(dsWhite$density,'density')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'density'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$density)-3*sd(dsRed$density))
# Llindar superior per el valors atípics de 'density'.
cat("Vi negre\nLlindar superior:",mean(dsRed$density)+3*sd(dsRed$density))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'density'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$density)-3*sd(dsWhite$density))
# Llindar superior per el valors atípics de 'density'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$density)+3*sd(dsWhite$density))

```

En el cas de la '*densitat*', obtenim valors atípics, però no estem segurs de que siguin incorrectes. Les 
distribucions queden ben descrites per els paràmetres estadístics com la mediana. No volem perdre informació 
del dataset i per tant **no eliminem ni modifiquem cap valor**.

#### 2.3.2.9 Valors extrems de l'atribut: pH

```{r extem_values_ph, out.width='80%'}
# Valors extrems de 'pH'
cat("Vi negre")
bxplot_hist(dsRed$pH,'pH')
cat("Vi blanc")
bxplot_hist(dsWhite$pH,'pH')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'pH'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$pH)-3*sd(dsRed$pH))
# Llindar superior per el valors atípics de 'pH'.
cat("Vi negre\nLlindar superior:",mean(dsRed$pH)+3*sd(dsRed$pH))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'pH'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$pH)-3*sd(dsWhite$pH))
# Llindar superior per el valors atípics de 'pH'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$pH)+3*sd(dsWhite$pH))

```

En el cas del '*pH*', és igual que el cas anterior, **podem mantenir els valors atípics**, ja que poden ser valors correctes i no tenim seguretat d'error. En general abans de modificar les dades cal estar segur de que realment és necessari, perque podriem estar eliminant patrons en les dades que per no semblar-nos 'coherents' d'entrada, són valors que indiquen una variació en una tendència incipient.

Sabem que el 'pH' marca la acidesa del vi, per tant és probable que el 'pH' tingui alguna correlació amb els atributs 'fixed.acidity' o 'citric.acid'.

#### 2.3.2.10 Valors extrems de l'atribut: sulphates

```{r extem_values_sulphates, out.width='80%'}
# Valors extrems de 'sulphates'
cat("Vi negre")
bxplot_hist(dsRed$sulphates,'sulphates')
cat("Vi blanc")
bxplot_hist(dsWhite$sulphates,'sulphates')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'sulphates'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$sulphates)-3*sd(dsRed$sulphates))
# Llindar superior per el valors atípics de 'sulphates'.
cat("Vi negre\nLlindar superior:",mean(dsRed$sulphates)+3*sd(dsRed$sulphates))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'sulphates'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$sulphates)-3*sd(dsWhite$sulphates))
# Llindar superior per el valors atípics de 'sulphates'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$sulphates)+3*sd(dsWhite$sulphates))

```

Els 'sulphates' i calci apareixen en l'aigua i per tant el raïm i el vi poden contenir-los. Una alta concentració dels mateixos podria fer que una aigua no fos de qualitat alimentària. Una aigua amb una quantitat de sulfats inferior a 250mg /l es considera en aquest aspecte una aigua de qualitat i amb valors superiors a 400 mg / l insalubre.

Per tant suposem aquest camp important per determinar la qualitat del vi. Igual que en els dos darrers cassos no trobem valors atípics que no puguin ser correctes, i per tant **conservem tots els valors**.

#### 2.3.2.11 Valors extrems de l'atribut: alcohol

```{r extem_values_alcohol, out.width='80%'}
# Valors extrems de 'alcohol'
cat("Vi negre")
bxplot_hist(dsRed$alcohol,'alcohol')
cat("Vi blanc")
bxplot_hist(dsWhite$alcohol,'alcohol')

# Cas Vi negre
# Llindar inferior per els valors atípics de 'alcohol'.
cat("Vi negre\nLlindar inferior:",mean(dsRed$alcohol)-3*sd(dsRed$alcohol))
# Llindar superior per el valors atípics de 'alcohol'.
cat("Vi negre\nLlindar superior:",mean(dsRed$alcohol)+3*sd(dsRed$alcohol))

# Cas Vi blanc
# Llindar inferior per els valors atípics de 'alcohol'.
cat("Vi blanc\nLlindar inferior:",mean(dsWhite$alcohol)-3*sd(dsWhite$alcohol))
# Llindar superior per el valors atípics de 'alcohol'.
cat("Vi negre\nLlindar superior:",mean(dsWhite$alcohol)+3*sd(dsWhite$alcohol))

```

En de l'alcohol, tampoc trobem valors atípics que no puguin ser correctes, i per tant **conservem tots els valors**. En aquest cas observem l'antiguitat del dataset perquè actualment la tendència en els darrers anys en la gradució dels vins éstà per sobre de 13º, (sobretot en el vi negre).

### 2.3.3 Definció del dataset definitiu.

Un cop tractats els valors buits, zeros i identificats i tractats els valors atípics de tots els atributs, definim una nova versió del dataset de vins.

```{r dataset_final}

# Tenim capçaleres iguals, si la suma de noms iguals és la suma total de camps.
a<-colnames(dsRed)
b<-colnames(dsWhite)
cat(paste0("El nombre de camps (",ncol(dsRed),") és igual al nombre de camps iguals ",
           sum(a==b)))

# Combinem les mostres dels dos fitxers i factoritzem el camp color per determinar 
# els valors que pren: 'blanc i 'negre'
d<-rbind(dsRed,dsWhite)
d$color<-factor(d$color)

# Dimensions del dataset:
cat("Files - Instàncies:",nrow(d),"\nColumnes-Atributs-Variables:",ncol(d),"\n")

# Comprovem els valors del dataset:
head(d)
tail(d)
```

\newpage
## 2.4 Anàlisi de les dades.

### 2.4.1 Selecció dels grups de dades i planificació dels anàlisis.

En primer lloc, comprovarem si el color del vi influeix en la seva qualitat.

Després volem extreure patrons de correlació entre atributs, i per això calculem una matriu de correlació usant l’index de correlació de Pearson. L’ordre en que les característiques són llistades en la matriu, és correspón amb una ordenació de component principal (paràmetre **order**). 

També definirem grups en l’atribut més correlacionat amb la qualitat del vi i compararem estadísticament la qualitat del vi per cadascuna de les categories definides.

Finalment crearem un model de regressió lineal multiple utilitzant 5 regressors per tal de poder realitzar prediccions de la qualitat del vi.

Primer de tot analitzem la variable de qualitat del vi per saber si depen del color:

```{r seleccio_dades, out.width='80%'}
# Visualitzem el boxplot de la qualitat segons color del vi.
par(mfrow=c(1,2))

# Vi negre
boxplot(d[d$color=='negre',"quality"], ylim=c(3,9), col="lightblue", xlab="Qualitat\nVi Negre")
# Vi blanc
boxplot(d[d$color=='blanc',"quality"], col="lightblue", xlab="Qualitat\nVi Blanc")

par(mfrow=c(1,1))
```

Hem elaborat els boxplot de cada tipus de vi en paral·lel per poder-los comparar bé.
Observem que **amb les dades que disposem**, no hin han diferències, es a dir coneixent el color del vi no podem determinar la seva qualitat. Necessitem cercar informació de la qualitat en els elements de la seva composició.

Calculem ara les matrius de correlació del vi negre i el vi blanc, usant l’index de correlació de Pearson.

#### 2.4.1.1 Selecció dels grups de dades del Vi Negre

```{r selection_red}
# Vi negre
nc=ncol(dsRed)
df <- dsRed[,1:11]
df$quality <- as.integer(dsRed[,12])
correlacio <- cor(df,method="pearson")
corrplot(correlacio, number.cex = 2, method = "square", hclust.method = "ward", order = "FPC",
         type = "full", tl.cex=0.8,tl.col = "navy")
```

De la matriu anterior podem establir les següents correlacions entre atributs per el vi negre:

| Tipus de correlació | Atributs que correlacionen |
| ----------------------------- | ----------------------------------------------- |
| Alta correlació | total.sulfur.dioxide amb free.sulfur.dioxide |
| Alta correlació | fixed.acidity amb density i citric.acid |
| Correlació relativa | alcohol amb qualitat |
| Alta correlació inversa | fixed.acidity amb pH |
| Correlació relativa inversa | citric.acid amb pH i volatile.acidity |


#### 2.4.1.2 Selecció dels grups de dades del Vi Blanc

```{r selection_white}
# Vi blanc
nc=ncol(dsWhite)
df <- dsWhite[,1:11]
df$quality <- as.integer(dsWhite[,12])
correlacio <- cor(df,method="pearson")
corrplot(correlacio, number.cex = 2, method = "square", hclust.method = "ward", order = "FPC",
         type = "full", tl.cex=0.8,tl.col = "navy")

```

De la matriu anterior podem establir les següents correlacions entre atributs per el vi blanc:

| Tipus de correlació | Atributs que correlacionen |
| ----------------------------- | ----------------------------------------------- |
| Alta correlació | total.sulfur.dioxide amb free.sulfur.dioxide |
| Alta correlació | densitat amb residual.sugar |
| Correlació relativa | alcohol amb qualitat |
| Alta correlació inversa | densitat amb alcohol |
| Correlació relativa inversa | alcohol amb residual.sugar |
| Correlació relativa inversa | total.sulfur.dioxide i fixed.acidity amb pH |

#### 2.4.1.3 Planificació de l'anàlisi

Amb els resultats dels dos apartats anteriors decidim seleccionar els atributs com característiques representatives de la qualitat del vi:

- **alcohol**
- **volatile.acidity** i 
- **sulfats**

Són les característiques que més correlació o correlació inversa tenen amb els dos tipus de vins.

En les següents proves estadístiques es compararà el valor de qualitat del vi blanc i negre amb l'**alcohol** que és la característica amb la que té més correlació.

Establim les següents categories:

```{r categories_set}
ah_Class<-data.frame("Molt Baixa"="< 12.5%", 
                     "Moderadament baixa"="[12.5%, 13.5%)",
                     "Alta"="[13.5%, 14.5%]", 
                     "Molt Alta"=" > 14.5%")
kable(ah_Class,caption=paste0("Taula ",1,": Classificació de la graduació dels vins."),  
      align=c('c','c','c','c')) %>% 
  column_spec(1,  color='black', bold = T, background = "orange") %>%
  column_spec(2,  color='white', bold = T, background = "blue") %>%
  column_spec(3,  color='white', bold = T, background = "blue") %>%
  column_spec(4,  color='black', bold = T, background = "orange") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F)

# Definició de grups de graduació d'alcohol en el vi.
d1<-d
d1["alcohol_class"]<-""
d1[d1$alcohol<9.5,'alcohol_class']<-"Molt_Baixa"
d1[d1$alcohol>=9.5 & d1$alcohol<12.5,'alcohol_class']<-"Moderadament_Baixa"
d1[d1$alcohol>=12.5 & d1$alcohol<=14,'alcohol_class']<-"Alta"
d1[d1$alcohol>14,'alcohol_class']<-"Molt_Alta"

summary(d[,c("alcohol","color","quality")])

```

### 2.4.2 Comprovació de la normalitat i homogeneïtat de la variància.

Mirem la normalitat de la ‘qualitat’ del vi.

**Normalitat de la Qualitat**

Primer observem la distribució de la qualitat segons cada tipus de vi:

```{r quality_distribution}
par(mfrow=c(1,3))
# Visualització de l'histograma
hist(d[d$color=='negre',"quality"], 
     breaks=length(unique(d[d$color=='negre',"quality"])), 
     main="Qualitat del Vi Negre", 
     xlab="Vi negre", ylab="Freqüència")
hist(d[d$color=='blanc',"quality"], 
     breaks=length(unique(d[d$color=='blanc',"quality"])), 
     main="Qualitat del Vi Blanc", 
     xlab="Vi blanc", ylab="Freqüència")
hist(d[,"quality"], 
     breaks=length(unique(d[,"quality"])), 
     main="Qualitat del Vi", 
     xlab="Vinho Verde", ylab="Freqüència")
par(mfrow=c(1,1))
```

Ara cerquem si la seva distribució és **normal** per cada tipus de vi:

```{r quality_qqplot}
# Gràfic QQ-plot de la variable 'quality' segons tipus de color ('negre','blanc').
# Utilitzem la funció qqPlot de la llibreria "car".
qqPlot(quality~color, data=d, envelope=.95, col='royalblue',col.lines='darkorange',lwd=1)
```

Si observem les dues gràfiques Q-Q plots **no indiquen normalitat de manera estricta**, doncs en les cues, ens allunyem de la recta de referència. En general, la forma de la mostra no es d’una recta. La gràfica Q-Q plot és molt intuitiva però no és definitiva, així que podem confirmar aquest resultat amb el test de normalitat de **Shapiro-Wilk**:


```{r quality_shapiro}
shw_Negre<-shapiro.test(d[d$color=="negre",'quality'])
shw_Blanc<-shapiro.test(d[d$color=="blanc",'quality'])
shw_Negre
print(shw_Negre$p.value)
shw_Blanc
print(shw_Blanc$p.value)
```

En quan al resultat del test de **Shapiro-Wilk**, obtenim el valor de l’estadistic **W** i la probabilitat **p-valor**:

- per “negre”: 0.85816 i p-valor = **2.266894^{-35}**
- i per “blanc”: 0.89089 i p-valor = **1.275358^{-49}** 


En els dos cassos **rebutgem la hipotesis H0 de normalitat**, perque el **p-value es inferior a 0.05**.

El valor de l’estadístic W, és recomenable però, que sigui proper a W=0.99 per obtenir bons resultats, i que el p-valor sigui superior a 0.05 per afirmar que la mostra pot estar originada en una població normal. 

Dels resultats del test de Shapiro-Wilk **deduïm que la ‘qualitat’ del vi no segueix una ditribució normal per cap tipus de vi**.

**Normalitat del Alcohol**

Estudiem ara la normalitat de la distribució d’alcohol del vi, aplicant directament el test de Shapiro-Wilk:

```{r alcohol_shapiro}
shw1_Negre<-shapiro.test(d[d$color=="negre",'alcohol'])
shw1_Blanc<-shapiro.test(d[d$color=="blanc",'alcohol'])
shw1_Negre
print(shw1_Negre$p.value)
shw1_Blanc
print(shw1_Blanc$p.value)
```

Per el alcohol, el resultat del test de **Shapiro-Wilk**, obtenim el valor de l’estadistic **W** i la probabilitat **p-valor**:

- per “negre”: 0.93121 i p-valor = **3.082983e^{-26}**
- i per “blanc”: 0.95923 i p-valor = **1.880557^{-34}**

En els dos cassos **rebutgem la hipotesis H0 de normalitat**, perque el **p-value es inferior a 0.05**.

El valor de l’estadístic W, és recomenable però, que sigui proper a W=0.99 per obtenir bons resultats, i que el p-valor sigui superior a 0.05 per afirmar que la mostra pot estar originada en una població normal. 

Concloem del test de Shapiro-Wilk que **la graduació d’alcohol del vi no segueix una ditribució normal per cap tipus de vi**.

Al obtenir resultats de no normalitat, comprovar la homogeneïtat de la variancia no és necessàri.

### 2.4.3 Aplicació de proves estadístiques per comparar els grups de dades. 

> En funció de les dades i de l’objectiu de l’estudi, aplicar proves de contrast d’hipòtesis, correlacions, regressions, etc. Aplicar almenys tres mètodes d’anàlisi diferents.

Com els tests de no normalitat, són afirmatius haurem de comparar dades amb proves no paramètriques. Per l’atribut alcohol disposem d’una categorització de 4 valors. Volem comprovar si els grups creats són estadísticament significatius. Per fer-ho aplicarem el **test de kruskal-Wallis** que ens permet veure si la ‘qualitat’ del vi és estadisticament diferent per cada grup de graduació d’alcohol definit en el cas de disposar de 3 o més grups:

```{r alcohol_kruskall}
# Aplicació del test de Kruskal-Wallis
d1$alcohol<-d$alcohol
d1$alcohol_class<-factor(d1$alcohol_class,
                         labels=c("Molt_Baixa","Moderadament_Baixa","Alta","Molt_Alta"))
kr1<-kruskal.test(d1$quality~d1$alcohol_class)


```

Amb un nivell de significancia de 0.05, arribem a la conclusió de que **la qualitat del vi per els grups de graduació considerats (Molt_Baixa, Moderadament_Baixa, Alta i Molt_Alta) és diferent**.

Finalment generem un model de regressió lineal múltiple per els atributs: **alcohol, citric.acid, sulphates, pH i color** amb variable depenent **quality**:
La variable **color**, és categòrica per tant definirem un variable dummy, indicant quína serà la categoria de referència (‘negre’):

```{r reference_category}
# Definim la categoria de referència de colorR:
d2<-d
d2$colorR<-relevel(d2$color,ref='negre')
head(d2,1)
# Comprovem que ho hem definit bé:
contrasts(d2$colorR)

```

Busquem explicar Y (quality) en funció de x1: alcohol, X2: citric.acid, x3: sulphates, x4: pH, x5: colorR

$$Y= \beta0 + \beta1\chi1 + \beta2\chi2 + \beta3\chi3 + \beta4\chi4 + \beta5\chi5 + e$$

on:

- $\beta j$ per j=0,1..5 són els coeficients desconeguts que volem estimar.
- **e** és l’error o residu que representa l’efecte de totes les variables que poden afectar a Y, però que no es contemplen.

**Càlcul del model:**

Executem la regressió lineal múltiple amb 5 regressors (alcohol, citric.acid, sulphates, pH, colorR) i una variables ‘dummy’ (color):

```{r regression}
m1<-lm(quality~alcohol+citric.acid+sulphates+pH+colorR, data=d2)
summary(m1)
```

De la sortida resum del model podem observar que el **p-value** associat al contrast és inferior a 0.05>. Per tant **com a mínim una de les variables explicatives contribueix de manera significativa a explicar la variable Y** de la qualitat del vi. 

**Bondat de l'ajust**

De la sortida del model, obtenim **R2 ajustat** = **`r summary(m1)$adj.r.squared`**. Les variables utilitzades expliquen en un **`r round(summary(m1)$adj.r.squared*100,2)`%** el model, però no és un valor proper a 1 com nosaltres voldriem. Cal utilitzar el **coeficient de determinació ajustat** perque a diferència del coeficient de determinació no ajustat, no incrementa sempre quan augmentem el nombre de variables en el model.

Els coeficients estimats i els seus p-valor són:

```{r stimated_coefs}
p_valor<-summary(m1)[["coefficients"]][, "Pr(>|t|)"]
coefs<-m1$coefficients
taula<-data.frame("Coeficients_Beta"=coefs,"P_Valor"=p_valor)
kable(taula,caption="Taula: Paràmetres estimats i p-valor.") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                full_width = F)
coefsr<-round(coefs,2)

```

i el model queda definit per la següent equació de regressió d'ajust:

**quality**$_i$ = **`r  round(m1$coefficients[1],2)`** + **`r  round(m1$coefficients[2],2)`**·$\chi1$ + **`r  round(m1$coefficients[3],2)`**·$\chi2$ + **`r round(m1$coefficients[4],2)`**·$\chi3$ + **`r round(m1$coefficients[5],2)`**·$\chi4$ + **`r  round(m1$coefficients[6],2)`**·$\chi5$  + **e**

En un model de regressió multilineal, els coeficients de regressió associats a cadascuna de les **variables fictícies** (en anglès **dummy**) són interpretades com la diferència esperada entre la mitjana de la sortida de la propia variable en comparació amb la del seu valor de referència, quan la resta de variables són constants. I si volem comparar dues categories qualsevols d’una variable ‘dummy’ aleshores podem fer la diferència entre els seus coeficients estimats.

En la següent taula podem observar les equacions del model que obtenim segons els diferents valors de la variable qualitativa **colorR**, considerant la resta de variables constants:

```{r model_equations}
# Construïm la taula resum dels models:
taula1=data.frame("colorRBlanc"=c(0,1), 
                  "Significat"=c("Vi negre.","Vi blanc"),
                  "Model"=c(paste0("Y'=",coefsr[1]," + ",coefsr[2],"·alcohol",
                                   " + ",coefsr[3],"·citric.acid"," + ",
                                   coefsr[4],"·sulphates"," + ",coefsr[5],
                                   "·pH"," + ",coefsr[6],"·1")))

print("Tenint en compte la equació anterior:")

kable(taula1, 
      caption="Taula: Equacions del model segons valors de les variables dummy.") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                full_width = F)

```

\newpage

**Interpretació dels paràmetres**

- **(Intercept)** *B0 = `r coefsr[1]`* Valor que pren la variable Y (quality) quan tots els regressors qualitatius són zero. La interpretació no la fem per no tenir sentit composició del vi igual a 0.
- **Alcohol** *B1 = `r coefsr[2]`* El coeficient estimat és positiu. La variable depenent 'quality' CREIX una proporció de `r coefsr[2]` quan aumenta una unitat (1 grau) la graduació d'alcohol, i la resta de variables es mantenen constants. El p-valor de la variable 'alcohol' és inferior a 0.05 per tant rebutgem la hipotesi de que la variable no contribueix al model.
- **citric.acid** *B2 = `r coefsr[3]`* El coeficient estimat és positiu. La variable depenent 'quality' s'INCREMENTA una proporció de `r coefsr[3]` quan aumenta una unitat de citric.acid, i la resta de variables es mantenen constants. El p-valor de la variable 'citric.acid' és inferior a 0.05 per tant rebutgem la hipotesi de que la variable no contribueix al model.
- **sulphates** *B3 = `r coefsr[4]`* El coeficient estimat és positiu. La variable depenent 'quality' CREIX una proporció de `r coefsr[4]` quan aumenta una unitat el component de sulphates, i la resta de variables es mantenen constants. El p-valor de la variable 'sulphates' és inferior a 0.05 per tant rebutgem la hipotesi de que la variable no contribueix al model.
- **pH** *B4 = `r coefsr[5]`* El coeficient estimat és positiu. La variable depenent 'quality' CREIX una proporció de `r coefsr[5]` quan aumenta una unitat el component de pH, i la resta de variables es mantenen constants. El p-valor de la variable 'pH' és inferior a 0.05 per tant rebutgem la hipotesi de que la variable no contribueix al model.
- **colorRblanc** *B5 = `r coefsr[6]`* El coeficient estimat és positiu. Al ser positiu representa un increment de qualitat `r coefsr[6]` (`r round(coefsr[6]*100,2)`%) del vi blanc respecte el vi negre (que és la categoria de referència), quan la resta de variables resta constant. El seu p-valor es major a 0.05 per tant el coeficient no és significatiu i podríem eliminar la variable del model.

Podem comprovar que si elimienm la variable **pH** del model, obtenim resultats semblants:

```{r without_ph}
# regressió lineal multiple sense el pH:
m2<-lm(quality~alcohol+citric.acid+sulphates+colorR, data=d2)
summary(m2)
```

Finalment també comprovem el model resultant si escollim els components del vi més correlacionats amb la qualitat del vi, però observem que els resultats **no milloren** molt:

```{r more_correlated}
# regressió lineal amb els components més correlacionats amb la qualitat del vi:
m3<-lm(quality~alcohol+volatile.acidity+sulphates+colorR, data=d2)
summary(m3)
```

\newpage
## 2.5 Representació dels resultats a partir de taules i gràfiques.

Al llarg de la pràctica hem anat combinant les operacions i anàlisis realitzats amb visualitzacions gràfiques dels resultats (matrius  de correlació, gràfics Q-Q Plot, histogrames, taules en els models de regressió).

En aquest cas visualitzarem el comportament de la categorització de la graduació d'alcohol, que com a resultat dels nostres anàlisis, pot estar categoritzada i ens pot permetre determinar la qualitat del vi.

En l'apartat d'anàlisi hem obtingut que els grups definits eren estadísticament diferents a partir de les dades disponibles. Utilitzant un gràfic de boxplot, podem veure que:

```{r resuts_boxplot}
# Gràfics boxplot de la qualitat del vi per cada tipus de vi respecte cada categoria definida en la graduació.
par(mfrow=c(1,2))
boxplot(d1[d1$color=='negre','quality']~d1[d1$color=='negre','alcohol_class'],
        ylab='Quality', main='Alcohol\nen Vi Negre', las=2)
boxplot(d1[d1$color=='blanc','quality']~d1[d1$color=='blanc','alcohol_class'],
        ylab='Quality', main='Alcohol\nen Vi Blanc', las=2)
par(mfrow=c(1,1))
```

Apliquem un gràfic per cada tipus de vi, ja que el color en si no ens determina la qualitat del vi.

Per el vi negre:

- Quan la graduació és inferior a 9.5º: la qualitat com a minim és de 5, el valor més freqüent és 6, i és la categoria on trobem les qualitats més altes fins 8. Ens trobem amb vins de qualitat bona.
- Quan la gradució es troba entre 9.5º i és inferior a 12.5º: la qualitat no superarà el 7, i la pitjor no és inferior a 4, per tant ens trobem majoritàriament en vins de qualitat acceptable-bona
- Si la graduació es troba entre 12.5º i 14.5º: la qualitat és 5. Ens trobem amb vins de qualitat correcta però no bona.
- Si la graduació es major que 14.5º: Podem trobar algun vi de qualitat notable, però majoritariament la qualitat és acceptable.

Per el vi blanc:

- Quan la graduació és inferior a 9.5º: la qualitat com a minim és de 5 i el valor més freqüent és 5 ó 6, i és la categoria on trobem les qualitats més altes fins 9. Ens trobem amb vins de qualitat bona.
- Quan la gradució es troba entre 9.5º i és inferior a 12.5º: el vin blanc es comporta com el negre.
- Si la graduació es troba entre 12.5º i 14.5º: A diferència del negre, és sempre de qualitat notable.
- Si la graduació es major que 14.5º: Podem trobar vins de molta qualitat però majoritariament la qualitat és acceptable.

\newpage
## 2.6. Resolució del problema i conclusions. 

> A partir dels resultats obtinguts, quines són les conclusions? Els resultats permeten respondre al problema?

En les conclusions finals, podem resumir que tenim la seguretat de que **la qualitat del vi no depen del seu color**, i que ens **hem de centrar en la seva composició per fer pronòstics de qualitat** per cada tipus de vi per separat.

També podem concloure que **la graduació d’alcohol és el element que més ens pot determinar més la qualitat del vi** d’entre els que disposem però **tampoc amb un grau de correlació molt alt (0.44)**. Segons aquests resultats hem definit varies categories de graduació. A més a més hem analitzat si les podiem considerar diferents amb resultats satisfactoris.

Recordem que per les categories fixades: `r levels(d1$alcohol_class)` hem aplicat el Test de Kruskal-Wallis que ens ha determinat amb un nivell de significació de 0,05 que **la qualitat del vi per els grups de graduació considerats és diferent**.

També hem pogut determinar la qualitat del vi segons la seva graduació, sempre tenint en compte el tipus de vi (negre o blanc). 

Els resultats obtinguts si que ens permeten respondre al problema però no amb resultats gaire satisfactoris. La conclusió és que **cal revisar el dataset i potser equilibrar-lo millor** en quan a la quantitat de mostres de cada qualitat de vi per mirar de millorar els resultats del vi. Vegem que hi ha una sobre representació de vins de qualitat mitja i molts pocs vins de molt alta qualitat o qualitat baixa, i sabem que no respon a una distribució donat els resultats dels QQPlots i els Test de Shapiro-Wilk, per lo que pensem que per ventura la mostra estigui esbiaixada cap a vins de qualitat mitjana.

### 2.6.1 Contribucions i dades

**Contribucions**

| Contribucions             | Firma                 |
| ------------------------- | --------------------- |
| Investigació prèvia       | quimdalmases i jdiezm |
| Redacció de les respostes | quimdalmases i jdiezm |
| Desenvolupament de codi   | quimdalmases i jdiezm |

**Dades**

Les dades originals provenen de:

- wineQualityInfo.txt es pot descarregar [aquí](https://github.com/jjdiezm/Practica2/blob/master/wineQualityInfo.txt)
- winequality-red.csv es pot descarregar [aquí](https://github.com/jjdiezm/Practica2/blob/master/winequality-red.csv)
- winequality-white.csv es pot descarregar [aquí](https://github.com/jjdiezm/Practica2/blob/master/winequality-white.csv)
- winequality.names es pot descarregar [aquí](https://github.com/jjdiezm/Practica2/blob/master/winequality.names)

Les dades finals analitzades es poden trobar a:

- dataset_final.csv es pot descarregar [aquí](https://github.com/jjdiezm/Practica2/blob/master/dataset_final.csv)


```{r dades_finals}
# Volquem el dataset final per a lliurar-lo
write.csv(d1,"dataset_final.csv",row.names = TRUE)
```

\newpage
# 3 Recursos
